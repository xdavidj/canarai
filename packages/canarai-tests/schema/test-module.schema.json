{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "canar.ai Test Module",
  "description": "Schema for canar.ai prompt injection test modules",
  "type": "object",
  "required": ["id", "version", "metadata", "payloads", "canary_markers", "observation", "classification"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^CAN-\\d{4}$"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "metadata": {
      "type": "object",
      "required": ["name", "description", "category", "severity", "author", "created"],
      "properties": {
        "name": {"type": "string"},
        "description": {"type": "string"},
        "category": {
          "type": "string",
          "enum": ["instruction_override", "data_exfiltration", "tool_action_abuse", "system_prompt_leakage", "goal_hijacking", "context_manipulation", "encoding_bypass", "multi_turn_chained", "structured_data_injection", "persona_manipulation"]
        },
        "severity": {
          "type": "string",
          "enum": ["common", "uncommon", "emerging"]
        },
        "tags": {"type": "array", "items": {"type": "string"}},
        "references": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "title": {"type": "string"},
              "url": {"type": "string", "format": "uri"}
            }
          }
        },
        "author": {
          "type": "object",
          "required": ["name"],
          "properties": {
            "name": {"type": "string"},
            "github": {"type": "string"}
          }
        },
        "created": {"type": "string", "format": "date"},
        "changelog": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "version": {"type": "string"},
              "date": {"type": "string"},
              "description": {"type": "string"}
            }
          }
        }
      }
    },
    "payloads": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["delivery_method", "content", "placement"],
        "properties": {
          "delivery_method": {
            "type": "string",
            "enum": ["css_display_none", "css_visibility_hidden", "css_opacity_zero", "white_on_white_text", "offscreen_positioning", "zero_font_size", "html_comment", "aria_hidden", "meta_tag", "json_ld", "microdata", "image_alt_text", "data_attribute", "css_pseudo_element", "svg_text", "noscript_block", "form_hidden_field"]
          },
          "content": {"type": "string"},
          "placement": {
            "type": "string",
            "enum": ["body_top", "body_bottom", "inline", "head"]
          },
          "encoding": {
            "type": "string",
            "enum": ["none", "base64", "rot13"],
            "default": "none"
          },
          "language": {"type": "string", "default": "en"}
        }
      }
    },
    "canary_markers": {
      "type": "array",
      "minItems": 1,
      "items": {"type": "string"}
    },
    "observation": {
      "type": "object",
      "required": ["detection_type", "indicators", "timeout_seconds"],
      "properties": {
        "detection_type": {
          "type": "string",
          "enum": ["canary_string", "beacon_callback", "dom_mutation", "navigation_event", "form_interaction", "composite"]
        },
        "indicators": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["type", "value", "indicates", "weight"],
            "properties": {
              "type": {"type": "string", "enum": ["string_match", "url_pattern", "dom_change", "network_request", "form_submit", "navigation"]},
              "value": {"type": "string"},
              "indicates": {"type": "string"},
              "weight": {"type": "number", "minimum": 0, "maximum": 1}
            }
          }
        },
        "timeout_seconds": {"type": "integer", "minimum": 1, "maximum": 120}
      }
    },
    "classification": {
      "type": "object",
      "required": ["secure_behavior", "vulnerable_behavior"],
      "properties": {
        "secure_behavior": {"type": "string"},
        "vulnerable_behavior": {"type": "string"}
      }
    }
  }
}
